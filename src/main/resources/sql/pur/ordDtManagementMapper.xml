<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="kr.happyjob.study.pur.dao.OrdDtManagementDao">

	<!-- 주문내역 + 검색 -->
	 <select id="ordDtManagementList" resultType="kr.happyjob.study.pur.model.OrdDtManagementVO">
						     
			select jn.JORD_CODE
			       , jn.loginID 
			       , pn.MODEL_NAME
			       , pn.PD_NAME
			       , jn.JORD_AMT
			       , jn.JORD_DATE
			       , jn.JORD_IN
			from JORDER_INFO jn
			inner join PD_INFO pn 
			on jn.MODEL_CODE = pn.MODEL_CODE
			
		<!-- <where>				  
		  	<if test="(searchKey != null) and (!searchKey.equals(''))">
		  		<choose>
		  		    <when test="(searchKey != null) and (searchKey eq 'cpname'.toString())">
		  				AND jn.loginID LIKE CONCAT('%', #{searchWord}, '%')	
		  				<if test="(!sdate.equals('')) or (!edate.equals(''))">
		  					<![CDATA[
		  						AND jn.JORD_DATE >= DATE(#{sdate}) 
		  						AND jn.JORD_DATE < DATE(#{edate})+1
		  					]]>						  					
		  				</if>	  				
		  			</when>
		  			 <when test="(searchKey != null) and (searchKey eq 'pdname'.toString())">
		  				AND pn.MODEL_NAME LIKE CONCAT('%', #{searchWord}, '%')	
		  				<if test="(!sdate.equals('')) or (!edate.equals(''))">
		  					<![CDATA[
		  						AND jn.JORD_DATE >= DATE(#{sdate}) 
		  						AND jn.JORD_DATE < DATE(#{edate})+1
		  					]]>						  					
		  				</if>	  				
		  			</when>
		  				<otherwise>
		  				AND (jn.loginID LIKE CONCAT('%', #{searchWord}, '%')	
		  				or pn.MODEL_NAME LIKE CONCAT('%', #{searchWord}, '%'))
		  				<if test="(!sdate.equals('')) or (!edate.equals(''))">
		  					<![CDATA[
		  						AND jn.JORD_DATE >= DATE(#{sdate}) 
		  						AND jn.JORD_DATE < DATE(#{edate})+1
		  					]]>						  					
		  				</if>	
		  				</otherwise>	  			 
		  		</choose>
		  	</if>
		  </where>   -->
		  <where>   
   <if test="(searchWord != null) and (!searchWord.equals(''))">
      <choose>
         <when test="(searchKey != null) and (searchKey eq 'cpname'.toString())">
                             AND  jn.loginID LIKE CONCAT('%', #{searchWord}, '%')   
         </when>
         <when test="(searchKey != null) and (searchKey eq 'pdname'.toString())">
                             AND pn.MODEL_NAME LIKE CONCAT('%', #{searchWord}, '%') 
         </when>
      </choose>   
   </if>

   <if test="(sdate != null) and (!sdate.equals(''))">
      <![CDATA[
                          AND jn.JORD_DATE >= DATE(#{sdate}) 
                       ]]>     
   </if>
   <if test="(edate != null) and (!edate.equals(''))">
      <![CDATA[
                          AND jn.JORD_DATE < DATE(#{edate})+1
                       ]]>     
   </if>
</where>
		  order by jn.JORD_CODE DESC
		  LIMIT #{pageIndex}, #{pageSize}
		  
	</select>

	<!-- 주문내역 총카운트 -->
	<select id="ordDtManagementTotalCnt" resultType="int">
						     
			select count(*)
			from JORDER_INFO jn
			inner join PD_INFO pn on jn.MODEL_CODE = pn.MODEL_CODE
			<where>			  
		  	<if test="(searchKey != null) and (!searchKey.equals(''))">
		  		<choose>
		  		
		  		    <when test="(searchKey != null) and (searchKey eq 'cpname'.toString())">
		  				AND jn.loginID LIKE CONCAT('%', #{searchWord}, '%')	
		  				<if test="(!sdate.equals('')) or (!edate.equals(''))">
		  					<![CDATA[
		  						AND jn.JORD_DATE >= DATE(#{sdate}) 
		  						AND jn.JORD_DATE < DATE(#{edate})+1
		  					]]>						  					
		  				</if>	  				
		  			</when>
		  			 <when test="(searchKey != null) and (searchKey eq 'pdname'.toString())">
		  				AND pn.MODEL_NAME LIKE CONCAT('%', #{searchWord}, '%')	
		  				<if test="(!sdate.equals('')) or (!edate.equals(''))">
		  					<![CDATA[
		  						AND jn.JORD_DATE >= DATE(#{sdate}) 
		  						AND jn.JORD_DATE < DATE(#{edate})+1
		  					]]>						  					
		  				</if>	  				
		  			</when>
		  					  			 
		  		</choose>
		  	</if>
		  </where>  
	</select>

	<!-- 단건조회 -->
	<select id="ordDtManagementSelect" resultType="kr.happyjob.study.pur.model.OrdDtManagementVO">
						     
			select jn.JORD_CODE
			       , jn.loginID 
			       , pn.MODEL_NAME
			       , pn.PD_NAME
			       , jn.JORD_AMT
			       , jn.JORD_DATE
			       , jn.JORD_IN
			from JORDER_INFO jn
			       inner join PD_INFO pn on jn.MODEL_CODE = pn.MODEL_CODE
	
			where jn.JORD_CODE = #{jordCode}
		
	</select> 

	<update id="updateBordType">
		UPDATE JORDER_INFO jn, PD_INFO pn
		      SET jn.JORD_IN = '1'
		WHERE  jn.JORD_CODE = #{jordCode}
			 AND pn.MODEL_CODE = jn.MODEL_CODE
	</update>
	
</mapper>