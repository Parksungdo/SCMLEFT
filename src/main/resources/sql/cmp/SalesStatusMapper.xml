<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="kr.happyjob.study.cmp.dao.SalesStatusDao">

	<!-- 매출현황 목록 조회 -->
	<select id = "transactionHistory" resultType = "kr.happyjob.study.cmp.model.SalesStatusModel">
     SELECT             
            UI.company 
            ,SUM(PD.PD_PRICE * JI.JORD_AMT) AS 'macul'
       FROM JORDER_INFO JI 
            INNER JOIN PD_INFO PD ON JI.MODEL_CODE = PD.MODEL_CODE
            INNER JOIN tb_userinfo UI ON JI.loginID = UI.loginID
      WHERE (JI.JORD_CODE, JI.MODEL_CODE) not in (   
                                                      select ifnull(JORD_CODE,0), ifnull(MODEL_CODE,0) from RETURN_INFO 
                                                 )
        and (JI.JORD_CODE, JI.MODEL_CODE)      in (   
                                                      select ifnull(JORD_CODE,0), ifnull(MODEL_CODE,0) from SHIP_INFO where SH_TYPE = '1'  
                                                  )                                          
        and UI.company Like CONCAT('%', #{comName}, '%')
        <if test="stDate != ''">
            and JI.JORD_DATE BETWEEN #{stDate} and #{edDate}    
        </if>   
   group by JI.loginID 
   
   limit #{pageIndex}, #{pageSize}
	</select>
	
	<!-- 매출현황 목록 총 갯수 조회 -->
	<select id="transactionHistoryCnt" resultType="int" parameterType="java.util.HashMap">
	select count(*) 
	  from (	
		     SELECT count(*)
			   FROM JORDER_INFO JI 
		            INNER JOIN PD_INFO PD ON JI.MODEL_CODE = PD.MODEL_CODE
		            INNER JOIN tb_userinfo UI ON JI.loginID = UI.loginID
		      WHERE (JI.JORD_CODE, JI.MODEL_CODE) not in (   
		                                                      select ifnull(JORD_CODE,0), ifnull(MODEL_CODE,0) from RETURN_INFO 
		                                                 )
		        and (JI.JORD_CODE, JI.MODEL_CODE)      in (   
		                                                      select ifnull(JORD_CODE,0), ifnull(MODEL_CODE,0) from SHIP_INFO where SH_TYPE = '1'  
		                                                  )                                          
		        and UI.company Like CONCAT('%', #{comName}, '%')
		        <if test="stDate != ''">
		            and JI.JORD_DATE BETWEEN #{stDate} and #{edDate}    
		        </if>
		        group by JI.loginID 
		    ) JJ;  
	
	</select>	
	
	<!-- 매출현황 상세내역 조회 -->
	<select id="dtlList" resultType = "kr.happyjob.study.cmp.model.SalesStatusModel">
	 SELECT  
             UI.company
            ,PD.PD_NAME AS 'MODEL_NAME'
            
            ,IFNULL(((PD.PD_PRICE * ifnull(JI.JORD_AMT,0))), 0) AS 'price',
             DATE_FORMAT(JI.JORD_DATE, '%Y-%m-%d') AS 'dtldate'
       FROM JORDER_INFO JI 
            INNER JOIN PD_INFO PD ON JI.MODEL_CODE = PD.MODEL_CODE
            INNER JOIN tb_userinfo UI ON JI.loginID = UI.loginID
            
      WHERE (JI.JORD_CODE, JI.MODEL_CODE) not in (   
                                                      select ifnull(JORD_CODE,0), ifnull(MODEL_CODE,0) from RETURN_INFO 
                                                 )
        and (JI.JORD_CODE, JI.MODEL_CODE)      in (   
                                                      select ifnull(JORD_CODE,0), ifnull(MODEL_CODE,0) from SHIP_INFO where SH_TYPE = '1'  
                                                  )                                          
        and company = #{comName2}
   
	</select>	
	
	<!-- 매출현황 상세내역 총 갯수 조회 -->
	<select id="dtlLisCnt" resultType="int">
		
		SELECT count(*)
		  FROM JORDER_INFO JI 
               INNER JOIN PD_INFO PD ON JI.MODEL_CODE = PD.MODEL_CODE
               INNER JOIN tb_userinfo UI ON JI.loginID = UI.loginID
            
         WHERE (JI.JORD_CODE, JI.MODEL_CODE) not in (   
                                                      select ifnull(JORD_CODE,0), ifnull(MODEL_CODE,0) from RETURN_INFO 
                                                 )
           and (JI.JORD_CODE, JI.MODEL_CODE)      in (   
                                                      select ifnull(JORD_CODE,0), ifnull(MODEL_CODE,0) from SHIP_INFO where SH_TYPE = '1'  
                                                  )                                          
           and company = #{comName2}
		
	</select>	

</mapper>

